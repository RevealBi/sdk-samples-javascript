<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reveal Sdk - Web Component</title>
    

    <style>
        .revealView {
            width: 100%;
            height: 100vh;
        }

        .Reveal-Thumbnail-Box {
            position: relative;
            z-index: 0;
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            height: 280px;
            width: 330px;
            margin: 15px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .Reveal-Thumbnail-Box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: #007bff;
        }

        .thumbnail-image {
            flex: 1;
            min-height: 200px;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #dee2e6;
            position: relative;
        }

        .thumbnail-title {
            padding: 15px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            background-color: white;
            color: #495057;
            border-top: 1px solid #dee2e6;
        }

        .thumbnails-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            max-height: 70vh;
            overflow-y: auto;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 45%;
        }
    </style>
</head>

<body>
    <div id="revealView" class="revealView"></div>

    <dialog id="dbSelector" class="modal">
        <h2>Select Dashboard</h2>
        <div id="thumbnails" class="thumbnails-container">
            <div class="loading-spinner"></div>
        </div>
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="closeDialog()" style="padding: 10px 20px; font-size: 16px;">Cancel</button>
        </div>
    </dialog>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    
    <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
    <script src="https://dl.revealbi.io/reveal/libs/1.8.0/infragistics.reveal.js"></script>

    <script type="text/javascript">
        $.ig.RevealSdkSettings.setBaseUrl("http://localhost:5111/");

        const dialog = document.getElementById("dbSelector");

        $.ig.RVDashboard.loadDashboard("Marketing").then(dashboard => {
            revealView = new $.ig.RevealView("#revealView");
            revealView.dashboard = dashboard;

            revealView.onDashboardSelectorRequested = (args) => {
                openDialog(args.callback);
            }
        });

        function openDialog(callback) {
            // Show the dialog first with loading spinner
            dialog.showModal();
            
            // Fetch dashboards with their info
            fetch("http://localhost:5111/dashboards")
                .then(resp => resp.json())
                .then(data => {
                    var container = document.querySelector("#thumbnails");
                    container.innerHTML = "";

                    data.forEach(dashboardData => {
                        createThumbnailWithInfo(container, dashboardData, callback);
                    });
                })
                .catch(error => {
                    console.error('Error fetching dashboards:', error);
                    var container = document.querySelector("#thumbnails");
                    container.innerHTML = "<p>Error loading dashboards. Please try again.</p>";
                });
        }

        function createThumbnailWithInfo(container, dashboardData, callback) {
            const thumbnailBox = document.createElement("div");
            thumbnailBox.className = "Reveal-Thumbnail-Box";
            
            // Create thumbnail image container
            const thumbnailImageDiv = document.createElement("div");
            thumbnailImageDiv.className = "thumbnail-image";
            thumbnailImageDiv.id = `thumb-${dashboardData.name}`;
            
            // Create title container
            const titleDiv = document.createElement("div");
            titleDiv.className = "thumbnail-title";
            titleDiv.textContent = dashboardData.title || dashboardData.name;
            
            // Add click event
            thumbnailBox.addEventListener('click', () => {
                callback(dashboardData.name);
                closeDialog();
            });
            
            // Assemble the thumbnail
            thumbnailBox.appendChild(thumbnailImageDiv);
            thumbnailBox.appendChild(titleDiv);
            container.appendChild(thumbnailBox);
            
            // Generate the thumbnail using Reveal SDK
            if (dashboardData.info) {
                try {
                    const thumbnailView = new $.ig.RevealDashboardThumbnailView(`#thumb-${dashboardData.name}`);
                    thumbnailView.dashboardInfo = dashboardData.info;
                } catch (error) {
                    console.error('Error creating thumbnail for', dashboardData.name, error);
                    thumbnailImageDiv.innerHTML = '<div style="color: #6c757d;">Preview not available</div>';
                }
            } else {
                thumbnailImageDiv.innerHTML = '<div style="color: #6c757d;">No preview available</div>';
            }
        }

        function closeDialog() {
            dialog.close();
        }

    </script>
</body>

</html>